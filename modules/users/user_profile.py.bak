# -*- coding: utf-8 -*-
"""
Profil aktuÃ¡lnÄ› pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QGroupBox, QFormLayout,
    QLineEdit, QPushButton, QLabel, QFrame, QMessageBox, QTabWidget
)
from PyQt6.QtCore import Qt, pyqtSignal
from PyQt6.QtGui import QFont
from datetime import datetime
from database_manager import db
from utils_auth import (
    get_current_user_id, get_current_username,
    hash_password, verify_password
)
import config


class UserProfile(QWidget):
    """Widget pro profil pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele"""

    profile_updated = pyqtSignal()

    def __init__(self, parent=None):
        super().__init__(parent)

        self.user_data = None

        self.init_ui()
        self.load_profile()

    def init_ui(self):
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(15, 15, 15, 15)
        main_layout.setSpacing(15)

        top_panel = self.create_top_panel()
        main_layout.addWidget(top_panel)

        tabs = QTabWidget()
        tabs.addTab(self.create_profile_tab(), "ðŸ‘¤ OsobnÃ­ Ãºdaje")
        tabs.addTab(self.create_password_tab(), "ðŸ”‘ ZmÄ›na hesla")
        tabs.addTab(self.create_activity_tab(), "ðŸ“Š Moje aktivita")

        main_layout.addWidget(tabs)

        self.setStyleSheet(f"""
            QTabWidget::pane {{
                background-color: white;
                border: 1px solid #d0d0d0;
                border-radius: 5px;
            }}
            QTabBar::tab {{
                background-color: #e0e0e0;
                padding: 10px 20px;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }}
            QTabBar::tab:selected {{
                background-color: white;
                border-bottom: 2px solid {config.COLOR_SECONDARY};
            }}
            QLineEdit {{
                padding: 8px;
                border: 1px solid #d0d0d0;
                border-radius: 4px;
                background-color: white;
            }}
            QLineEdit:focus {{
                border-color: {config.COLOR_SECONDARY};
            }}
            QGroupBox {{
                font-weight: bold;
                border: 1px solid #d0d0d0;
                border-radius: 5px;
                margin-top: 10px;
                padding-top: 10px;
                background-color: white;
            }}
            QGroupBox::title {{
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px;
            }}
        """)

    def create_top_panel(self):
        panel = QFrame()
        panel.setObjectName("topPanel")
        layout = QHBoxLayout(panel)
        layout.setContentsMargins(10, 10, 10, 10)

        title = QLabel("ðŸ‘¤âš™ï¸ MÅ¯j profil")
        title.setObjectName("sectionTitle")
        font = QFont()
        font.setPointSize(14)
        font.setBold(True)
        title.setFont(font)
        layout.addWidget(title)

        layout.addStretch()

        self.lbl_username = QLabel("")
        self.lbl_username.setStyleSheet("color: #666; font-style: italic;")
        layout.addWidget(self.lbl_username)

        panel.setStyleSheet(f"""
            #topPanel {{
                background-color: #f8f9fa;
                border-radius: 5px;
                border: 1px solid #e0e0e0;
            }}
            #sectionTitle {{
                color: {config.COLOR_PRIMARY};
            }}
        """)

        return panel

    def create_profile_tab(self):
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)

        info_group = QGroupBox("OsobnÃ­ Ãºdaje")
        info_layout = QFormLayout(info_group)
        info_layout.setSpacing(12)

        self.txt_username = QLineEdit()
        self.txt_username.setReadOnly(True)
        self.txt_username.setStyleSheet("background-color: #f0f0f0;")
        info_layout.addRow("UÅ¾ivatelskÃ© jmÃ©no:", self.txt_username)

        self.txt_full_name = QLineEdit()
        self.txt_full_name.setPlaceholderText("VaÅ¡e celÃ© jmÃ©no")
        info_layout.addRow("CelÃ© jmÃ©no:", self.txt_full_name)

        self.txt_email = QLineEdit()
        self.txt_email.setPlaceholderText("vas@email.cz")
        info_layout.addRow("Email:", self.txt_email)

        self.txt_phone = QLineEdit()
        self.txt_phone.setPlaceholderText("+420 123 456 789")
        info_layout.addRow("Telefon:", self.txt_phone)

        layout.addWidget(info_group)

        role_group = QGroupBox("Role a oprÃ¡vnÄ›nÃ­")
        role_layout = QFormLayout(role_group)
        role_layout.setSpacing(12)

        self.lbl_role = QLabel("--")
        self.lbl_role.setStyleSheet("font-weight: bold;")
        role_layout.addRow("VaÅ¡e role:", self.lbl_role)

        self.lbl_permissions_count = QLabel("--")
        role_layout.addRow("PoÄet oprÃ¡vnÄ›nÃ­:", self.lbl_permissions_count)

        layout.addWidget(role_group)

        layout.addStretch()

        buttons_layout = QHBoxLayout()
        buttons_layout.addStretch()

        self.btn_save_profile = QPushButton("ðŸ’¾ UloÅ¾it zmÄ›ny")
        self.btn_save_profile.setObjectName("primaryButton")
        self.btn_save_profile.clicked.connect(self.save_profile)
        buttons_layout.addWidget(self.btn_save_profile)

        layout.addLayout(buttons_layout)

        tab.setStyleSheet(f"""
            #primaryButton {{
                background-color: {config.COLOR_SECONDARY};
                color: white;
                border: none;
                border-radius: 5px;
                padding: 10px 25px;
                font-weight: bold;
            }}
            #primaryButton:hover {{
                background-color: #2980b9;
            }}
        """)

        return tab

    def create_password_tab(self):
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)

        password_group = QGroupBox("ZmÄ›na hesla")
        password_layout = QFormLayout(password_group)
        password_layout.setSpacing(12)

        self.txt_current_password = QLineEdit()
        self.txt_current_password.setEchoMode(QLineEdit.EchoMode.Password)
        self.txt_current_password.setPlaceholderText("Zadejte aktuÃ¡lnÃ­ heslo")
        password_layout.addRow("AktuÃ¡lnÃ­ heslo:", self.txt_current_password)

        self.txt_new_password = QLineEdit()
        self.txt_new_password.setEchoMode(QLineEdit.EchoMode.Password)
        self.txt_new_password.setPlaceholderText("Zadejte novÃ© heslo")
        self.txt_new_password.textChanged.connect(self.check_password_strength)
        password_layout.addRow("NovÃ© heslo:", self.txt_new_password)

        self.txt_confirm_password = QLineEdit()
        self.txt_confirm_password.setEchoMode(QLineEdit.EchoMode.Password)
        self.txt_confirm_password.setPlaceholderText("PotvrÄte novÃ© heslo")
        password_layout.addRow("PotvrzenÃ­ hesla:", self.txt_confirm_password)

        self.lbl_password_strength = QLabel("SÃ­la hesla: --")
        self.lbl_password_strength.setStyleSheet("color: #666;")
        password_layout.addRow("", self.lbl_password_strength)

        layout.addWidget(password_group)

        requirements_group = QGroupBox("PoÅ¾adavky na heslo")
        requirements_layout = QVBoxLayout(requirements_group)

        requirements_text = QLabel(
            "â€¢ MinimÃ¡lnÄ› 6 znakÅ¯\n"
            "â€¢ DoporuÄeno: velkÃ¡ a malÃ¡ pÃ­smena\n"
            "â€¢ DoporuÄeno: alespoÅˆ jedno ÄÃ­slo\n"
            "â€¢ NesmÃ­ bÃ½t stejnÃ© jako uÅ¾ivatelskÃ© jmÃ©no"
        )
        requirements_text.setStyleSheet("color: #666;")
        requirements_layout.addWidget(requirements_text)

        layout.addWidget(requirements_group)

        layout.addStretch()

        buttons_layout = QHBoxLayout()
        buttons_layout.addStretch()

        self.btn_change_password = QPushButton("ðŸ”‘ ZmÄ›nit heslo")
        self.btn_change_password.setObjectName("primaryButton")
        self.btn_change_password.clicked.connect(self.change_password)
        buttons_layout.addWidget(self.btn_change_password)

        layout.addLayout(buttons_layout)

        tab.setStyleSheet(f"""
            #primaryButton {{
                background-color: {config.COLOR_SECONDARY};
                color: white;
                border: none;
                border-radius: 5px;
                padding: 10px 25px;
                font-weight: bold;
            }}
            #primaryButton:hover {{
                background-color: #2980b9;
            }}
        """)

        return tab

    def create_activity_tab(self):
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)

        stats_group = QGroupBox("Statistiky ÃºÄtu")
        stats_layout = QFormLayout(stats_group)
        stats_layout.setSpacing(12)

        self.lbl_created_at = QLabel("--")
        stats_layout.addRow("ÃšÄet vytvoÅ™en:", self.lbl_created_at)

        self.lbl_last_login = QLabel("--")
        stats_layout.addRow("PoslednÃ­ pÅ™ihlÃ¡Å¡enÃ­:", self.lbl_last_login)

        self.lbl_login_count = QLabel("--")
        stats_layout.addRow("Celkem pÅ™ihlÃ¡Å¡enÃ­:", self.lbl_login_count)

        self.lbl_password_age = QLabel("--")
        stats_layout.addRow("StÃ¡Å™Ã­ hesla:", self.lbl_password_age)

        layout.addWidget(stats_group)

        session_group = QGroupBox("AktuÃ¡lnÃ­ sezenÃ­")
        session_layout = QFormLayout(session_group)
        session_layout.setSpacing(12)

        self.lbl_session_start = QLabel(datetime.now().strftime("%d.%m.%Y %H:%M"))
        session_layout.addRow("PÅ™ihlÃ¡Å¡en od:", self.lbl_session_start)

        layout.addWidget(session_group)

        layout.addStretch()

        return tab

    def load_profile(self):
        user_id = get_current_user_id()
        if not user_id:
            return

        row = db.fetch_one(...)
        self.user_data = dict(row) if row else {}

        if not self.user_data:
            return

        self.lbl_username.setText(f"PÅ™ihlÃ¡Å¡en jako: {self.user_data['username']}")
        self.txt_username.setText(self.user_data['username'])
        self.txt_full_name.setText(self.user_data['full_name'] or "")
        self.txt_email.setText(self.user_data['email'] or "")

        if 'phone' in self.user_data:
            self.txt_phone.setText(self.user_data['phone'] or "")

        self.lbl_role.setText(self.user_data['role'] or "Bez role")

        perm_count = db.fetch_one("""
            SELECT COUNT(DISTINCT p.id) as count
            FROM permissions p
            JOIN role_permissions rp ON p.id = rp.permission_id
            JOIN roles r ON rp.role_id = r.id
            WHERE r.name = ? AND rp.allowed = 1
        """, (self.user_data['role'],))

        if perm_count:
            self.lbl_permissions_count.setText(str(perm_count['count']))

        if self.user_data['created_at']:
            try:
                dt = datetime.fromisoformat(self.user_data['created_at'])
                self.lbl_created_at.setText(dt.strftime("%d.%m.%Y %H:%M"))
            except:
                self.lbl_created_at.setText(self.user_data['created_at'])

        if self.user_data and 'last_login' in self.user_data.keys():
            try:
                dt = datetime.fromisoformat(self.user_data['last_login'])
                self.lbl_last_login.setText(dt.strftime("%d.%m.%Y %H:%M"))
            except:
                self.lbl_last_login.setText(self.user_data['last_login'])

        self.lbl_login_count.setText(str(self.user_data.get('login_count', 0)))

        self.lbl_password_age.setText("NeznÃ¡mÃ©")

    def save_profile(self):
        user_id = get_current_user_id()
        if not user_id:
            return

        full_name = self.txt_full_name.text().strip()
        email = self.txt_email.text().strip() or None
        phone = self.txt_phone.text().strip() or None

        if not full_name:
            QMessageBox.warning(self, "Chyba", "CelÃ© jmÃ©no je povinnÃ©.")
            return

        try:
            db.execute_query("""
                UPDATE users SET
                    full_name = ?, email = ?, phone = ?, updated_at = ?
                WHERE id = ?
            """, (full_name, email, phone, datetime.now().isoformat(), user_id))

            QMessageBox.information(self, "ÃšspÄ›ch", "Profil byl ÃºspÄ›Å¡nÄ› aktualizovÃ¡n.")
            self.profile_updated.emit()

        except Exception as e:
            QMessageBox.critical(self, "Chyba", f"Chyba pÅ™i uklÃ¡dÃ¡nÃ­ profilu: {e}")

    def check_password_strength(self):
        password = self.txt_new_password.text()

        if not password:
            self.lbl_password_strength.setText("SÃ­la hesla: --")
            self.lbl_password_strength.setStyleSheet("color: #666;")
            return

        strength = 0

        if len(password) >= 6:
            strength += 1
        if len(password) >= 8:
            strength += 1
        if len(password) >= 12:
            strength += 1

        if any(c.isupper() for c in password):
            strength += 1
        if any(c.islower() for c in password):
            strength += 1
        if any(c.isdigit() for c in password):
            strength += 1
        if any(c in "!@#$%^&*()_+-=[]{}|;':\",./<>?" for c in password):
            strength += 1

        if strength <= 2:
            text = "SÃ­la hesla: ðŸ”´ SlabÃ©"
            color = config.COLOR_DANGER
        elif strength <= 4:
            text = "SÃ­la hesla: ðŸŸ¡ StÅ™ednÃ­"
            color = config.COLOR_WARNING
        elif strength <= 5:
            text = "SÃ­la hesla: ðŸŸ¢ SilnÃ©"
            color = config.COLOR_SUCCESS
        else:
            text = "SÃ­la hesla: ðŸ’ª Velmi silnÃ©"
            color = config.COLOR_SUCCESS

        self.lbl_password_strength.setText(text)
        self.lbl_password_strength.setStyleSheet(f"color: {color}; font-weight: bold;")

    def change_password(self):
        user_id = get_current_user_id()
        if not user_id or not self.user_data:
            return

        current_password = self.txt_current_password.text()
        new_password = self.txt_new_password.text()
        confirm_password = self.txt_confirm_password.text()

        if not current_password:
            QMessageBox.warning(self, "Chyba", "Zadejte aktuÃ¡lnÃ­ heslo.")
            return

        if not new_password:
            QMessageBox.warning(self, "Chyba", "Zadejte novÃ© heslo.")
            return

        if new_password != confirm_password:
            QMessageBox.warning(self, "Chyba", "NovÃ¡ hesla se neshodujÃ­.")
            return

        if len(new_password) < 6:
            QMessageBox.warning(self, "Chyba", "NovÃ© heslo musÃ­ mÃ­t alespoÅˆ 6 znakÅ¯.")
            return

        if new_password.lower() == self.user_data['username'].lower():
            QMessageBox.warning(self, "Chyba", "Heslo nesmÃ­ bÃ½t stejnÃ© jako uÅ¾ivatelskÃ© jmÃ©no.")
            return

        if not verify_password(current_password, self.user_data['password']):
            QMessageBox.warning(self, "Chyba", "AktuÃ¡lnÃ­ heslo nenÃ­ sprÃ¡vnÃ©.")
            return

        try:
            new_hash = hash_password(new_password)

            db.execute_query(
                "UPDATE users SET password = ?, updated_at = ? WHERE id = ?",
                (new_hash, datetime.now().isoformat(), user_id)
            )

            self.txt_current_password.clear()
            self.txt_new_password.clear()
            self.txt_confirm_password.clear()

            QMessageBox.information(self, "ÃšspÄ›ch", "Heslo bylo ÃºspÄ›Å¡nÄ› zmÄ›nÄ›no.")

            self.load_profile()

        except Exception as e:
            QMessageBox.critical(self, "Chyba", f"Chyba pÅ™i zmÄ›nÄ› hesla: {e}")

    def refresh(self):
        self.load_profile()
