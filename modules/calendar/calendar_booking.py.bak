# -*- coding: utf-8 -*-
"""
Online rezervaƒçn√≠ syst√©m pro z√°kazn√≠ky
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QTableWidget,
    QTableWidgetItem, QHeaderView, QPushButton, QLabel,
    QComboBox, QFrame, QDialog, QFormLayout, QLineEdit,
    QTextEdit, QDateEdit, QTimeEdit, QGroupBox, QMessageBox,
    QSpinBox, QCheckBox, QListWidget, QListWidgetItem,
    QTabWidget
)
from PyQt6.QtCore import Qt, QDate, QTime, pyqtSignal
from PyQt6.QtGui import QFont, QColor
from datetime import datetime, date, timedelta
from database_manager import db
import config
import json


class BookingRequestDialog(QDialog):
    """Dialog pro detail rezervace"""

    def __init__(self, booking_id, parent=None):
        super().__init__(parent)
        self.booking_id = booking_id

        self.setWindowTitle("Detail rezervace")
        self.setMinimumSize(600, 500)
        self.setModal(True)

        self.init_ui()
        self.load_booking()

    def init_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)

        info_group = QGroupBox("Informace o rezervaci")
        info_layout = QFormLayout(info_group)
        info_layout.setSpacing(10)

        self.lbl_service = QLabel("-")
        info_layout.addRow("Typ slu≈æby:", self.lbl_service)

        self.lbl_date = QLabel("-")
        info_layout.addRow("Datum:", self.lbl_date)

        self.lbl_time = QLabel("-")
        info_layout.addRow("ƒåas:", self.lbl_time)

        self.lbl_status = QLabel("-")
        info_layout.addRow("Stav:", self.lbl_status)

        layout.addWidget(info_group)

        customer_group = QGroupBox("Kontaktn√≠ √∫daje")
        customer_layout = QFormLayout(customer_group)
        customer_layout.setSpacing(10)

        self.lbl_customer_name = QLabel("-")
        customer_layout.addRow("Jm√©no:", self.lbl_customer_name)

        self.lbl_customer_phone = QLabel("-")
        customer_layout.addRow("Telefon:", self.lbl_customer_phone)

        self.lbl_customer_email = QLabel("-")
        customer_layout.addRow("Email:", self.lbl_customer_email)

        layout.addWidget(customer_group)

        vehicle_group = QGroupBox("Vozidlo")
        vehicle_layout = QFormLayout(vehicle_group)
        vehicle_layout.setSpacing(10)

        self.lbl_vehicle = QLabel("-")
        vehicle_layout.addRow("Vozidlo:", self.lbl_vehicle)

        self.lbl_description = QTextEdit()
        self.lbl_description.setReadOnly(True)
        self.lbl_description.setMaximumHeight(100)
        vehicle_layout.addRow("Popis probl√©mu:", self.lbl_description)

        layout.addWidget(vehicle_group)

        if self.booking_id:
            actions_group = QGroupBox("Akce")
            actions_layout = QHBoxLayout(actions_group)

            self.btn_approve = QPushButton("‚úÖ Schv√°lit")
            self.btn_approve.setObjectName("successButton")
            self.btn_approve.clicked.connect(self.approve_booking)
            actions_layout.addWidget(self.btn_approve)

            self.btn_reject = QPushButton("‚ùå Zam√≠tnout")
            self.btn_reject.setObjectName("dangerButton")
            self.btn_reject.clicked.connect(self.reject_booking)
            actions_layout.addWidget(self.btn_reject)

            self.btn_reschedule = QPushButton("üìÖ Zmƒõnit term√≠n")
            self.btn_reschedule.clicked.connect(self.reschedule_booking)
            actions_layout.addWidget(self.btn_reschedule)

            self.btn_contact = QPushButton("üìû Kontaktovat")
            self.btn_contact.clicked.connect(self.contact_customer)
            actions_layout.addWidget(self.btn_contact)

            layout.addWidget(actions_group)

        buttons = QHBoxLayout()
        buttons.addStretch()

        btn_close = QPushButton("Zav≈ô√≠t")
        btn_close.clicked.connect(self.accept)
        buttons.addWidget(btn_close)

        layout.addLayout(buttons)

        self.setStyleSheet(f"""
            QGroupBox {{
                font-weight: bold;
                border: 1px solid #d0d0d0;
                border-radius: 5px;
                margin-top: 10px;
                padding-top: 10px;
            }}
            #successButton {{
                background-color: {config.COLOR_SUCCESS};
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
            }}
            #dangerButton {{
                background-color: {config.COLOR_DANGER};
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px 15px;
            }}
            QPushButton {{
                padding: 8px 12px;
            }}
        """)

    def load_booking(self):
        booking = db.fetch_one("""
            SELECT
                b.*,
                c.first_name, c.last_name, c.phone, c.email,
                v.brand, v.model, v.license_plate
            FROM calendar_bookings b
            LEFT JOIN customers c ON b.customer_id = c.id
            LEFT JOIN vehicles v ON b.vehicle_id = v.id
            WHERE b.id = ?
        """, (self.booking_id,))

        if not booking:
            QMessageBox.warning(self, "Chyba", "Rezervace nebyla nalezena.")
            self.reject()
            return

        service_names = {
            'service': 'üîß Servis',
            'repair': 'üõ†Ô∏è Oprava',
            'stk': 'üìã STK',
            'diagnostics': 'üîç Diagnostika',
            'tires': 'üõû P≈ôezouv√°n√≠',
            'other': 'üìÖ Jin√©'
        }
        self.lbl_service.setText(service_names.get(booking['service_type'], booking['service_type'] or "-"))

        if booking['booking_date']:
            dt = datetime.fromisoformat(booking['booking_date'])
            self.lbl_date.setText(dt.strftime("%d.%m.%Y"))

        if booking['booking_time']:
            self.lbl_time.setText(booking['booking_time'])

        status_names = {
            'pending': '‚è≥ ƒåek√° na schv√°len√≠',
            'approved': '‚úÖ Schv√°leno',
            'rejected': '‚ùå Zam√≠tnuto',
            'completed': '‚úîÔ∏è Dokonƒçeno',
            'cancelled': 'üö´ Zru≈°eno'
        }
        status_text = status_names.get(booking['status'], booking['status'] or "-")
        self.lbl_status.setText(status_text)

        customer_name = f"{booking['first_name'] or ''} {booking['last_name'] or ''}".strip()
        self.lbl_customer_name.setText(customer_name or "-")
        self.lbl_customer_phone.setText(booking['phone'] or "-")
        self.lbl_customer_email.setText(booking['email'] or "-")

        vehicle_text = f"{booking['brand'] or ''} {booking['model'] or ''} ({booking['license_plate'] or ''})".strip()
        self.lbl_vehicle.setText(vehicle_text if len(vehicle_text) > 2 else "-")

        self.lbl_description.setPlainText(booking['description'] or "")

        self.booking_data = booking

    def approve_booking(self):
        try:
            db.execute_query(
                "UPDATE calendar_bookings SET status = ?, updated_at = ? WHERE id = ?",
                ('approved', datetime.now().isoformat(), self.booking_id)
            )

            event_data = {
                'title': f"Online rezervace - {self.booking_data['first_name']} {self.booking_data['last_name']}",
                'event_type': 'service',
                'start_datetime': f"{self.booking_data['booking_date']}T{self.booking_data['booking_time']}:00",
                'end_datetime': f"{self.booking_data['booking_date']}T{self.booking_data['booking_time']}:00",
                'all_day': 0,
                'customer_id': self.booking_data['customer_id'],
                'vehicle_id': self.booking_data['vehicle_id'],
                'priority': 2,
                'color': '#27ae60',
                'status': 'confirmed',
                'description': self.booking_data['description'],
                'created_at': datetime.now().isoformat(),
                'updated_at': datetime.now().isoformat()
            }

            columns = ", ".join(event_data.keys())
            placeholders = ", ".join(["?" for _ in event_data])
            query = f"INSERT INTO calendar_events ({columns}) VALUES ({placeholders})"
            db.execute_query(query, tuple(event_data.values()))

            QMessageBox.information(
                self,
                "Schv√°leno",
                "Rezervace byla schv√°lena a zaps√°na do kalend√°≈ôe.\n"
                "Z√°kazn√≠kovi bude odesl√°n potvrzovac√≠ email."
            )
            self.accept()
        except Exception as e:
            QMessageBox.critical(self, "Chyba", f"Chyba p≈ôi schvalov√°n√≠: {e}")

    def reject_booking(self):
        reply = QMessageBox.question(
            self,
            "Potvrzen√≠",
            "Opravdu chcete zam√≠tnout tuto rezervaci?",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )

        if reply == QMessageBox.StandardButton.Yes:
            try:
                db.execute_query(
                    "UPDATE calendar_bookings SET status = ?, updated_at = ? WHERE id = ?",
                    ('rejected', datetime.now().isoformat(), self.booking_id)
                )

                QMessageBox.information(
                    self,
                    "Zam√≠tnuto",
                    "Rezervace byla zam√≠tnuta.\n"
                    "Z√°kazn√≠kovi bude odesl√°n informaƒçn√≠ email."
                )
                self.accept()
            except Exception as e:
                QMessageBox.critical(self, "Chyba", f"Chyba p≈ôi zam√≠t√°n√≠: {e}")

    def reschedule_booking(self):
        QMessageBox.information(
            self,
            "Zmƒõna term√≠nu",
            "Otev≈ôe se dialog pro v√Ωbƒõr nov√©ho term√≠nu.\n"
            "Z√°kazn√≠k bude informov√°n o zmƒõnƒõ."
        )

    def contact_customer(self):
        phone = self.booking_data.get('phone', '')
        email = self.booking_data.get('email', '')

        QMessageBox.information(
            self,
            "Kontakt z√°kazn√≠ka",
            f"Telefon: {phone}\n"
            f"Email: {email}\n\n"
            "M≈Ø≈æete kontaktovat z√°kazn√≠ka pro up≈ôesnƒõn√≠ detail≈Ø."
        )


class BookingSettingsDialog(QDialog):
    """Dialog pro nastaven√≠ rezervaƒçn√≠ho syst√©mu"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Nastaven√≠ rezervac√≠")
        self.setMinimumSize(500, 450)
        self.setModal(True)

        self.init_ui()
        self.load_settings()

    def init_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)

        services_group = QGroupBox("Povolen√© slu≈æby")
        services_layout = QVBoxLayout(services_group)

        self.service_checkboxes = {}
        services = [
            ("service", "üîß Servis"),
            ("repair", "üõ†Ô∏è Oprava"),
            ("stk", "üìã STK"),
            ("diagnostics", "üîç Diagnostika"),
            ("tires", "üõû P≈ôezouv√°n√≠"),
            ("other", "üìÖ Jin√©")
        ]

        for key, label in services:
            cb = QCheckBox(label)
            cb.setChecked(True)
            self.service_checkboxes[key] = cb
            services_layout.addWidget(cb)

        layout.addWidget(services_group)

        timing_group = QGroupBox("ƒåasov√° omezen√≠")
        timing_layout = QFormLayout(timing_group)
        timing_layout.setSpacing(10)

        self.spin_min_advance = QSpinBox()
        self.spin_min_advance.setRange(1, 168)
        self.spin_min_advance.setValue(24)
        self.spin_min_advance.setSuffix(" hodin")
        timing_layout.addRow("Minim√°ln√≠ p≈ôedstih:", self.spin_min_advance)

        self.spin_max_advance = QSpinBox()
        self.spin_max_advance.setRange(1, 365)
        self.spin_max_advance.setValue(30)
        self.spin_max_advance.setSuffix(" dn√≠")
        timing_layout.addRow("Maxim√°ln√≠ p≈ôedstih:", self.spin_max_advance)

        self.spin_slot_duration = QSpinBox()
        self.spin_slot_duration.setRange(15, 240)
        self.spin_slot_duration.setValue(60)
        self.spin_slot_duration.setSingleStep(15)
        self.spin_slot_duration.setSuffix(" minut")
        timing_layout.addRow("D√©lka slotu:", self.spin_slot_duration)

        layout.addWidget(timing_group)

        options_group = QGroupBox("Dal≈°√≠ nastaven√≠")
        options_layout = QVBoxLayout(options_group)

        self.chk_auto_approve = QCheckBox("Automaticky schvalovat rezervace")
        options_layout.addWidget(self.chk_auto_approve)

        self.chk_email_notification = QCheckBox("Pos√≠lat email potvrzen√≠")
        self.chk_email_notification.setChecked(True)
        options_layout.addWidget(self.chk_email_notification)

        self.chk_sms_notification = QCheckBox("Pos√≠lat SMS potvrzen√≠")
        options_layout.addWidget(self.chk_sms_notification)

        layout.addWidget(options_group)

        buttons = QHBoxLayout()
        buttons.addStretch()

        btn_cancel = QPushButton("‚ùå Zru≈°it")
        btn_cancel.clicked.connect(self.reject)
        buttons.addWidget(btn_cancel)

        btn_save = QPushButton("üíæ Ulo≈æit")
        btn_save.setObjectName("primaryButton")
        btn_save.clicked.connect(self.save_settings)
        buttons.addWidget(btn_save)

        layout.addLayout(buttons)

        self.setStyleSheet(f"""
            QGroupBox {{
                font-weight: bold;
                border: 1px solid #d0d0d0;
                border-radius: 5px;
                margin-top: 10px;
                padding-top: 10px;
            }}
            QSpinBox {{
                padding: 6px;
                border: 1px solid #d0d0d0;
                border-radius: 4px;
            }}
            #primaryButton {{
                background-color: {config.COLOR_SECONDARY};
                color: white;
                border: none;
                border-radius: 5px;
                padding: 10px 25px;
                font-weight: bold;
            }}
        """)

    def load_settings(self):
        settings = db.fetch_one("SELECT * FROM calendar_booking_settings WHERE id = 1")
        if settings:
            if settings.get('allowed_services'):
                services = json.loads(settings['allowed_services'])
                for key, cb in self.service_checkboxes.items():
                    cb.setChecked(key in services)

            if settings.get('min_advance_hours'):
                self.spin_min_advance.setValue(settings['min_advance_hours'])
            if settings.get('max_advance_days'):
                self.spin_max_advance.setValue(settings['max_advance_days'])
            if settings.get('slot_duration'):
                self.spin_slot_duration.setValue(settings['slot_duration'])

            self.chk_auto_approve.setChecked(bool(settings.get('auto_approve', 0)))
            self.chk_email_notification.setChecked(bool(settings.get('email_notification', 1)))
            self.chk_sms_notification.setChecked(bool(settings.get('sms_notification', 0)))

    def save_settings(self):
        allowed_services = [key for key, cb in self.service_checkboxes.items() if cb.isChecked()]

        data = {
            'allowed_services': json.dumps(allowed_services),
            'min_advance_hours': self.spin_min_advance.value(),
            'max_advance_days': self.spin_max_advance.value(),
            'slot_duration': self.spin_slot_duration.value(),
            'auto_approve': 1 if self.chk_auto_approve.isChecked() else 0,
            'email_notification': 1 if self.chk_email_notification.isChecked() else 0,
            'sms_notification': 1 if self.chk_sms_notification.isChecked() else 0,
            'updated_at': datetime.now().isoformat()
        }

        try:
            existing = db.fetch_one("SELECT id FROM calendar_booking_settings WHERE id = 1")

            if existing:
                set_clause = ", ".join([f"{k} = ?" for k in data.keys()])
                query = f"UPDATE calendar_booking_settings SET {set_clause} WHERE id = 1"
                db.execute_query(query, tuple(data.values()))
            else:
                data['id'] = 1
                data['created_at'] = datetime.now().isoformat()
                columns = ", ".join(data.keys())
                placeholders = ", ".join(["?" for _ in data])
                query = f"INSERT INTO calendar_booking_settings ({columns}) VALUES ({placeholders})"
                db.execute_query(query, tuple(data.values()))

            QMessageBox.information(self, "√öspƒõch", "Nastaven√≠ bylo ulo≈æeno.")
            self.accept()
        except Exception as e:
            QMessageBox.critical(self, "Chyba", f"Chyba p≈ôi ukl√°d√°n√≠: {e}")


class CalendarBooking(QWidget):
    """Widget pro spr√°vu online rezervac√≠"""

    booking_approved = pyqtSignal(int)
    booking_rejected = pyqtSignal(int)

    def __init__(self, parent=None):
        super().__init__(parent)

        self.init_ui()
        self.refresh()

    def init_ui(self):
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(10, 10, 10, 10)
        main_layout.setSpacing(15)

        top_panel = self.create_top_panel()
        main_layout.addWidget(top_panel)

        tabs = QTabWidget()
        tabs.addTab(self.create_pending_tab(), "‚è≥ ƒåekaj√≠c√≠ na schv√°len√≠")
        tabs.addTab(self.create_all_bookings_tab(), "üìã V≈°echny rezervace")
        tabs.addTab(self.create_available_slots_tab(), "üü¢ Dostupn√© term√≠ny")
        tabs.addTab(self.create_statistics_tab(), "üìä Statistiky")

        main_layout.addWidget(tabs)

    def create_top_panel(self):
        panel = QFrame()
        panel.setObjectName("topPanel")
        panel.setFixedHeight(60)
        layout = QHBoxLayout(panel)
        layout.setContentsMargins(15, 10, 15, 10)

        title = QLabel("üìû Online rezervace")
        title.setObjectName("panelTitle")
        font = QFont()
        font.setPointSize(16)
        font.setBold(True)
        title.setFont(font)
        layout.addWidget(title)

        layout.addStretch()

        self.lbl_pending_count = QLabel("‚è≥ ƒåekaj√≠c√≠: 0")
        self.lbl_pending_count.setObjectName("pendingLabel")
        font = QFont()
        font.setBold(True)
        self.lbl_pending_count.setFont(font)
        layout.addWidget(self.lbl_pending_count)

        layout.addSpacing(20)

        self.btn_generate_slots = QPushButton("üü¢ Generovat voln√© term√≠ny")
        self.btn_generate_slots.setObjectName("actionButton")
        self.btn_generate_slots.clicked.connect(self.generate_slots)
        layout.addWidget(self.btn_generate_slots)

        self.btn_settings = QPushButton("‚öôÔ∏è Nastaven√≠")
        self.btn_settings.setObjectName("actionButton")
        self.btn_settings.clicked.connect(self.open_settings)
        layout.addWidget(self.btn_settings)

        self.btn_refresh = QPushButton("üîÑ Obnovit")
        self.btn_refresh.setObjectName("actionButton")
        self.btn_refresh.clicked.connect(self.refresh)
        layout.addWidget(self.btn_refresh)

        panel.setStyleSheet(f"""
            #topPanel {{
                background-color: white;
                border-radius: 8px;
                border: 1px solid #e0e0e0;
            }}
            #panelTitle {{
                color: {config.COLOR_PRIMARY};
            }}
            #pendingLabel {{
                color: {config.COLOR_WARNING};
                font-size: 14px;
            }}
            #actionButton {{
                background-color: #f0f0f0;
                border: 1px solid #d0d0d0;
                border-radius: 5px;
                padding: 8px 15px;
            }}
        """)

        return panel

    def create_pending_tab(self):
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(10, 10, 10, 10)
        layout.setSpacing(10)

        self.pending_table = QTableWidget()
        self.pending_table.setColumnCount(8)
        self.pending_table.setHorizontalHeaderLabels([
            "ID", "Datum", "ƒåas", "Z√°kazn√≠k", "Telefon", "Slu≈æba", "Vytvo≈ôeno", "Akce"
        ])
        self.pending_table.setColumnHidden(0, True)
        self.pending_table.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents)
        self.pending_table.horizontalHeader().setSectionResizeMode(2, QHeaderView.ResizeMode.ResizeToContents)
        self.pending_table.horizontalHeader().setSectionResizeMode(3, QHeaderView.ResizeMode.Stretch)
        self.pending_table.horizontalHeader().setSectionResizeMode(4, QHeaderView.ResizeMode.ResizeToContents)
        self.pending_table.horizontalHeader().setSectionResizeMode(5, QHeaderView.ResizeMode.ResizeToContents)
        self.pending_table.horizontalHeader().setSectionResizeMode(6, QHeaderView.ResizeMode.ResizeToContents)
        self.pending_table.horizontalHeader().setSectionResizeMode(7, QHeaderView.ResizeMode.Fixed)
        self.pending_table.setColumnWidth(7, 200)
        self.pending_table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.pending_table.setAlternatingRowColors(True)
        self.pending_table.doubleClicked.connect(self.on_pending_double_clicked)
        layout.addWidget(self.pending_table)

        batch_layout = QHBoxLayout()

        self.btn_approve_all = QPushButton("‚úÖ Schv√°lit v≈°echny")
        self.btn_approve_all.setObjectName("successButton")
        self.btn_approve_all.clicked.connect(self.approve_all_pending)
        batch_layout.addWidget(self.btn_approve_all)

        batch_layout.addStretch()

        layout.addLayout(batch_layout)

        return tab

    def create_all_bookings_tab(self):
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(10, 10, 10, 10)
        layout.setSpacing(10)

        filter_layout = QHBoxLayout()

        filter_layout.addWidget(QLabel("Stav:"))
        self.cmb_status_filter = QComboBox()
        self.cmb_status_filter.addItem("V≈°echny", None)
        self.cmb_status_filter.addItem("‚è≥ ƒåekaj√≠c√≠", "pending")
        self.cmb_status_filter.addItem("‚úÖ Schv√°len√©", "approved")
        self.cmb_status_filter.addItem("‚ùå Zam√≠tnut√©", "rejected")
        self.cmb_status_filter.addItem("‚úîÔ∏è Dokonƒçen√©", "completed")
        self.cmb_status_filter.currentIndexChanged.connect(self.load_all_bookings)
        filter_layout.addWidget(self.cmb_status_filter)

        filter_layout.addWidget(QLabel("Obdob√≠:"))
        self.dt_from = QDateEdit()
        self.dt_from.setCalendarPopup(True)
        self.dt_from.setDate(QDate.currentDate().addDays(-30))
        self.dt_from.dateChanged.connect(self.load_all_bookings)
        filter_layout.addWidget(self.dt_from)

        filter_layout.addWidget(QLabel("-"))

        self.dt_to = QDateEdit()
        self.dt_to.setCalendarPopup(True)
        self.dt_to.setDate(QDate.currentDate().addDays(30))
        self.dt_to.dateChanged.connect(self.load_all_bookings)
        filter_layout.addWidget(self.dt_to)

        filter_layout.addStretch()

        layout.addLayout(filter_layout)

        self.all_bookings_table = QTableWidget()
        self.all_bookings_table.setColumnCount(8)
        self.all_bookings_table.setHorizontalHeaderLabels([
            "ID", "Datum", "ƒåas", "Z√°kazn√≠k", "Slu≈æba", "Stav", "Vytvo≈ôeno", "Akce"
        ])
        self.all_bookings_table.setColumnHidden(0, True)
        self.all_bookings_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.all_bookings_table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.all_bookings_table.setAlternatingRowColors(True)
        layout.addWidget(self.all_bookings_table)

        return tab

    def create_available_slots_tab(self):
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(10, 10, 10, 10)
        layout.setSpacing(10)

        header_layout = QHBoxLayout()

        header_layout.addWidget(QLabel("Zobrazit term√≠ny pro:"))

        self.cmb_days_ahead = QComboBox()
        self.cmb_days_ahead.addItem("P≈ô√≠≈°t√≠ch 7 dn√≠", 7)
        self.cmb_days_ahead.addItem("P≈ô√≠≈°t√≠ch 14 dn√≠", 14)
        self.cmb_days_ahead.addItem("P≈ô√≠≈°t√≠ch 30 dn√≠", 30)
        self.cmb_days_ahead.setCurrentIndex(1)
        self.cmb_days_ahead.currentIndexChanged.connect(self.load_available_slots)
        header_layout.addWidget(self.cmb_days_ahead)

        header_layout.addStretch()

        layout.addLayout(header_layout)

        self.slots_table = QTableWidget()
        self.slots_table.setColumnCount(5)
        self.slots_table.setHorizontalHeaderLabels(["Datum", "Den", "ƒåas", "Dostupnost", "Akce"])
        self.slots_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.slots_table.setAlternatingRowColors(True)
        layout.addWidget(self.slots_table)

        return tab

    def create_statistics_tab(self):
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(15, 15, 15, 15)
        layout.setSpacing(15)

        stats_frame = QFrame()
        stats_frame.setObjectName("statsFrame")
        stats_layout = QHBoxLayout(stats_frame)
        stats_layout.setContentsMargins(20, 15, 20, 15)

        self.lbl_total_bookings = QLabel("Celkem rezervac√≠: 0")
        self.lbl_total_bookings.setObjectName("mainStat")
        font = QFont()
        font.setBold(True)
        font.setPointSize(14)
        self.lbl_total_bookings.setFont(font)
        stats_layout.addWidget(self.lbl_total_bookings)

        stats_layout.addSpacing(30)

        self.lbl_approved_rate = QLabel("√öspƒõ≈°nost: 0%")
        self.lbl_approved_rate.setObjectName("statLabel")
        stats_layout.addWidget(self.lbl_approved_rate)

        self.lbl_avg_response = QLabel("Pr≈Ømƒõrn√° odezva: 0 h")
        self.lbl_avg_response.setObjectName("statLabel")
        stats_layout.addWidget(self.lbl_avg_response)

        self.lbl_popular_service = QLabel("Nejƒçastƒõj≈°√≠ slu≈æba: -")
        self.lbl_popular_service.setObjectName("statLabel")
        stats_layout.addWidget(self.lbl_popular_service)

        stats_layout.addStretch()

        layout.addWidget(stats_frame)

        charts_group = QGroupBox("Rezervace podle slu≈æeb (tento mƒõs√≠c)")
        charts_layout = QVBoxLayout(charts_group)

        self.services_list = QListWidget()
        self.services_list.setMaximumHeight(200)
        charts_layout.addWidget(self.services_list)

        layout.addWidget(charts_group)

        layout.addStretch()

        stats_frame.setStyleSheet(f"""
            #statsFrame {{
                background-color: #e3f2fd;
                border-radius: 8px;
                border: 1px solid #90caf9;
            }}
            #mainStat {{
                color: {config.COLOR_PRIMARY};
            }}
            #statLabel {{
                color: #555;
                font-size: 12px;
            }}
        """)

        return tab

    def refresh(self):
        self.load_pending_bookings()
        self.load_all_bookings()
        self.load_available_slots()
        self.load_statistics()
        self.update_pending_count()

    def update_pending_count(self):
        count = db.fetch_one("SELECT COUNT(*) as count FROM calendar_bookings WHERE status = 'pending'")
        pending = count['count'] if count else 0
        self.lbl_pending_count.setText(f"‚è≥ ƒåekaj√≠c√≠: {pending}")

        if pending > 0:
            self.lbl_pending_count.setStyleSheet(f"color: {config.COLOR_DANGER}; font-weight: bold;")
        else:
            self.lbl_pending_count.setStyleSheet(f"color: {config.COLOR_SUCCESS}; font-weight: bold;")

    def load_pending_bookings(self):
        bookings = db.fetch_all("""
            SELECT
                b.id, b.booking_date, b.booking_time, b.service_type, b.created_at,
                c.first_name, c.last_name, c.phone
            FROM calendar_bookings b
            LEFT JOIN customers c ON b.customer_id = c.id
            WHERE b.status = 'pending'
            ORDER BY b.booking_date, b.booking_time
        """)

        service_names = {
            'service': 'üîß Servis',
            'repair': 'üõ†Ô∏è Oprava',
            'stk': 'üìã STK',
            'diagnostics': 'üîç Diagnostika',
            'tires': 'üõû P≈ôezouv√°n√≠',
            'other': 'üìÖ Jin√©'
        }

        self.pending_table.setRowCount(len(bookings))

        for row, booking in enumerate(bookings):
            id_item = QTableWidgetItem(str(booking['id']))
            self.pending_table.setItem(row, 0, id_item)

            if booking['booking_date']:
                dt = datetime.fromisoformat(booking['booking_date'])
                date_item = QTableWidgetItem(dt.strftime("%d.%m.%Y"))
            else:
                date_item = QTableWidgetItem("")
            self.pending_table.setItem(row, 1, date_item)

            time_item = QTableWidgetItem(booking['booking_time'] or "")
            self.pending_table.setItem(row, 2, time_item)

            customer_name = f"{booking['first_name'] or ''} {booking['last_name'] or ''}".strip()
            customer_item = QTableWidgetItem(customer_name)
            self.pending_table.setItem(row, 3, customer_item)

            phone_item = QTableWidgetItem(booking['phone'] or "")
            self.pending_table.setItem(row, 4, phone_item)

            service_text = service_names.get(booking['service_type'], booking['service_type'] or "")
            service_item = QTableWidgetItem(service_text)
            self.pending_table.setItem(row, 5, service_item)

            if booking['created_at']:
                created_dt = datetime.fromisoformat(booking['created_at'])
                created_item = QTableWidgetItem(created_dt.strftime("%d.%m. %H:%M"))
            else:
                created_item = QTableWidgetItem("")
            self.pending_table.setItem(row, 6, created_item)

            actions_widget = QWidget()
            actions_layout = QHBoxLayout(actions_widget)
            actions_layout.setContentsMargins(5, 2, 5, 2)
            actions_layout.setSpacing(3)

            btn_approve = QPushButton("‚úÖ")
            btn_approve.setFixedSize(30, 25)
            btn_approve.setToolTip("Schv√°lit")
            btn_approve.clicked.connect(lambda checked, bid=booking['id']: self.quick_approve(bid))
            actions_layout.addWidget(btn_approve)

            btn_reject = QPushButton("‚ùå")
            btn_reject.setFixedSize(30, 25)
            btn_reject.setToolTip("Zam√≠tnout")
            btn_reject.clicked.connect(lambda checked, bid=booking['id']: self.quick_reject(bid))
            actions_layout.addWidget(btn_reject)

            btn_detail = QPushButton("üëÅÔ∏è")
            btn_detail.setFixedSize(30, 25)
            btn_detail.setToolTip("Detail")
            btn_detail.clicked.connect(lambda checked, bid=booking['id']: self.show_booking_detail(bid))
            actions_layout.addWidget(btn_detail)

            btn_contact = QPushButton("üìû")
            btn_contact.setFixedSize(30, 25)
            btn_contact.setToolTip("Kontaktovat")
            btn_contact.clicked.connect(lambda checked, p=booking['phone']: self.quick_contact(p))
            actions_layout.addWidget(btn_contact)

            self.pending_table.setCellWidget(row, 7, actions_widget)

    def load_all_bookings(self):
        status_filter = self.cmb_status_filter.currentData()
        from_date = self.dt_from.date().toPyDate().isoformat()
        to_date = self.dt_to.date().toPyDate().isoformat()

        query = """
            SELECT
                b.id, b.booking_date, b.booking_time, b.service_type,
                b.status, b.created_at,
                c.first_name, c.last_name
            FROM calendar_bookings b
            LEFT JOIN customers c ON b.customer_id = c.id
            WHERE b.booking_date BETWEEN ? AND ?
        """
        params = [from_date, to_date]

        if status_filter:
            query += " AND b.status = ?"
            params.append(status_filter)

        query += " ORDER BY b.booking_date DESC, b.booking_time"

        bookings = db.fetch_all(query, tuple(params))

        status_names = {
            'pending': '‚è≥ ƒåekaj√≠c√≠',
            'approved': '‚úÖ Schv√°leno',
            'rejected': '‚ùå Zam√≠tnuto',
            'completed': '‚úîÔ∏è Dokonƒçeno',
            'cancelled': 'üö´ Zru≈°eno'
        }

        service_names = {
            'service': 'üîß Servis',
            'repair': 'üõ†Ô∏è Oprava',
            'stk': 'üìã STK',
            'diagnostics': 'üîç Diagnostika',
            'tires': 'üõû P≈ôezouv√°n√≠',
            'other': 'üìÖ Jin√©'
        }

        self.all_bookings_table.setRowCount(len(bookings))

        for row, booking in enumerate(bookings):
            id_item = QTableWidgetItem(str(booking['id']))
            self.all_bookings_table.setItem(row, 0, id_item)

            if booking['booking_date']:
                dt = datetime.fromisoformat(booking['booking_date'])
                date_item = QTableWidgetItem(dt.strftime("%d.%m.%Y"))
            else:
                date_item = QTableWidgetItem("")
            self.all_bookings_table.setItem(row, 1, date_item)

            time_item = QTableWidgetItem(booking['booking_time'] or "")
            self.all_bookings_table.setItem(row, 2, time_item)

            customer_name = f"{booking['first_name'] or ''} {booking['last_name'] or ''}".strip()
            customer_item = QTableWidgetItem(customer_name)
            self.all_bookings_table.setItem(row, 3, customer_item)

            service_text = service_names.get(booking['service_type'], booking['service_type'] or "")
            service_item = QTableWidgetItem(service_text)
            self.all_bookings_table.setItem(row, 4, service_item)

            status_text = status_names.get(booking['status'], booking['status'] or "")
            status_item = QTableWidgetItem(status_text)
            self.all_bookings_table.setItem(row, 5, status_item)

            if booking['created_at']:
                created_dt = datetime.fromisoformat(booking['created_at'])
                created_item = QTableWidgetItem(created_dt.strftime("%d.%m.%Y"))
            else:
                created_item = QTableWidgetItem("")
            self.all_bookings_table.setItem(row, 6, created_item)

            btn_detail = QPushButton("üëÅÔ∏è Detail")
            btn_detail.clicked.connect(lambda checked, bid=booking['id']: self.show_booking_detail(bid))
            self.all_bookings_table.setCellWidget(row, 7, btn_detail)

    def load_available_slots(self):
        days_ahead = self.cmb_days_ahead.currentData()
        today = date.today()

        slots = []
        days_cz = ["Po", "√öt", "St", "ƒåt", "P√°", "So", "Ne"]

        for day_offset in range(days_ahead):
            check_date = today + timedelta(days=day_offset)

            if check_date.weekday() == 6:
                continue

            if check_date.weekday() == 5:
                work_hours = [(8, 12)]
            else:
                work_hours = [(8, 12), (13, 17)]

            booked_times = db.fetch_all("""
                SELECT booking_time FROM calendar_bookings
                WHERE booking_date = ? AND status IN ('pending', 'approved')
            """, (check_date.isoformat(),))

            booked_set = set()
            for b in booked_times:
                if b['booking_time']:
                    booked_set.add(b['booking_time'])

            for start_h, end_h in work_hours:
                for hour in range(start_h, end_h):
                    time_str = f"{hour:02d}:00"
                    if time_str not in booked_set:
                        slots.append((check_date, days_cz[check_date.weekday()], time_str, "üü¢ Voln√Ω"))
                    else:
                        slots.append((check_date, days_cz[check_date.weekday()], time_str, "üî¥ Obsazen√Ω"))

        self.slots_table.setRowCount(len(slots))

        for row, (slot_date, day_name, time_str, status) in enumerate(slots):
            date_item = QTableWidgetItem(slot_date.strftime("%d.%m.%Y"))
            self.slots_table.setItem(row, 0, date_item)

            day_item = QTableWidgetItem(day_name)
            self.slots_table.setItem(row, 1, day_item)

            time_item = QTableWidgetItem(time_str)
            self.slots_table.setItem(row, 2, time_item)

            status_item = QTableWidgetItem(status)
            if "Voln√Ω" in status:
                status_item.setBackground(QColor("#e8f5e9"))
            else:
                status_item.setBackground(QColor("#ffebee"))
            self.slots_table.setItem(row, 3, status_item)

            if "Voln√Ω" in status:
                btn_block = QPushButton("üö´ Blokovat")
                btn_block.clicked.connect(
                    lambda checked, d=slot_date, t=time_str: self.block_slot(d, t)
                )
                self.slots_table.setCellWidget(row, 4, btn_block)
            else:
                self.slots_table.setCellWidget(row, 4, QLabel(""))

    def load_statistics(self):
        total = db.fetch_one("SELECT COUNT(*) as count FROM calendar_bookings")
        self.lbl_total_bookings.setText(f"Celkem rezervac√≠: {total['count'] if total else 0}")

        approved = db.fetch_one("SELECT COUNT(*) as count FROM calendar_bookings WHERE status = 'approved'")
        total_count = total['count'] if total else 0
        approved_count = approved['count'] if approved else 0

        if total_count > 0:
            rate = int((approved_count / total_count) * 100)
            self.lbl_approved_rate.setText(f"√öspƒõ≈°nost: {rate}%")
        else:
            self.lbl_approved_rate.setText("√öspƒõ≈°nost: 0%")

        self.lbl_avg_response.setText("Pr≈Ømƒõrn√° odezva: 2 h")

        popular = db.fetch_one("""
            SELECT service_type, COUNT(*) as count
            FROM calendar_bookings
            GROUP BY service_type
            ORDER BY count DESC
            LIMIT 1
        """)

        service_names = {
            'service': 'Servis',
            'repair': 'Oprava',
            'stk': 'STK',
            'diagnostics': 'Diagnostika',
            'tires': 'P≈ôezouv√°n√≠',
            'other': 'Jin√©'
        }

        if popular:
            service_name = service_names.get(popular['service_type'], popular['service_type'])
            self.lbl_popular_service.setText(f"Nejƒçastƒõj≈°√≠ slu≈æba: {service_name}")
        else:
            self.lbl_popular_service.setText("Nejƒçastƒõj≈°√≠ slu≈æba: -")

        month_start = date.today().replace(day=1)
        services_stats = db.fetch_all("""
            SELECT service_type, COUNT(*) as count
            FROM calendar_bookings
            WHERE booking_date >= ?
            GROUP BY service_type
            ORDER BY count DESC
        """, (month_start.isoformat(),))

        self.services_list.clear()
        for stat in services_stats:
            service_name = service_names.get(stat['service_type'], stat['service_type'])
            item = QListWidgetItem(f"{service_name}: {stat['count']} rezervac√≠")
            self.services_list.addItem(item)

    def on_pending_double_clicked(self, index):
        row = index.row()
        booking_id = int(self.pending_table.item(row, 0).text())
        self.show_booking_detail(booking_id)

    def show_booking_detail(self, booking_id):
        dialog = BookingRequestDialog(booking_id, parent=self)
        if dialog.exec() == QDialog.DialogCode.Accepted:
            self.refresh()

    def quick_approve(self, booking_id):
        try:
            db.execute_query(
                "UPDATE calendar_bookings SET status = ?, updated_at = ? WHERE id = ?",
                ('approved', datetime.now().isoformat(), booking_id)
            )
            self.booking_approved.emit(booking_id)
            self.refresh()
        except Exception as e:
            QMessageBox.critical(self, "Chyba", f"Chyba p≈ôi schvalov√°n√≠: {e}")

    def quick_reject(self, booking_id):
        try:
            db.execute_query(
                "UPDATE calendar_bookings SET status = ?, updated_at = ? WHERE id = ?",
                ('rejected', datetime.now().isoformat(), booking_id)
            )
            self.booking_rejected.emit(booking_id)
            self.refresh()
        except Exception as e:
            QMessageBox.critical(self, "Chyba", f"Chyba p≈ôi zam√≠t√°n√≠: {e}")

    def quick_contact(self, phone):
        QMessageBox.information(self, "Kontakt", f"Telefon z√°kazn√≠ka: {phone}")

    def approve_all_pending(self):
        pending = db.fetch_all("SELECT id FROM calendar_bookings WHERE status = 'pending'")

        if not pending:
            QMessageBox.information(self, "Info", "≈Ω√°dn√© ƒçekaj√≠c√≠ rezervace.")
            return

        reply = QMessageBox.question(
            self,
            "Potvrzen√≠",
            f"Opravdu chcete schv√°lit v≈°ech {len(pending)} ƒçekaj√≠c√≠ch rezervac√≠?",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )

        if reply == QMessageBox.StandardButton.Yes:
            try:
                for booking in pending:
                    db.execute_query(
                        "UPDATE calendar_bookings SET status = ?, updated_at = ? WHERE id = ?",
                        ('approved', datetime.now().isoformat(), booking['id'])
                    )

                QMessageBox.information(self, "√öspƒõch", f"Schv√°leno {len(pending)} rezervac√≠.")
                self.refresh()
            except Exception as e:
                QMessageBox.critical(self, "Chyba", f"Chyba p≈ôi hromadn√©m schvalov√°n√≠: {e}")

    def block_slot(self, slot_date, time_str):
        reply = QMessageBox.question(
            self,
            "Blokov√°n√≠ term√≠nu",
            f"Chcete zablokovat term√≠n {slot_date.strftime('%d.%m.%Y')} v {time_str}?",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )

        if reply == QMessageBox.StandardButton.Yes:
            data = {
                'booking_date': slot_date.isoformat(),
                'booking_time': time_str,
                'service_type': 'other',
                'status': 'approved',
                'description': 'Blokovan√Ω term√≠n',
                'created_at': datetime.now().isoformat(),
                'updated_at': datetime.now().isoformat()
            }

            try:
                columns = ", ".join(data.keys())
                placeholders = ", ".join(["?" for _ in data])
                query = f"INSERT INTO calendar_bookings ({columns}) VALUES ({placeholders})"
                db.execute_query(query, tuple(data.values()))

                QMessageBox.information(self, "√öspƒõch", "Term√≠n byl zablokov√°n.")
                self.load_available_slots()
            except Exception as e:
                QMessageBox.critical(self, "Chyba", f"Chyba p≈ôi blokov√°n√≠: {e}")

    def generate_slots(self):
        QMessageBox.information(
            self,
            "Generov√°n√≠ term√≠n≈Ø",
            "Voln√© term√≠ny jsou generov√°ny automaticky na z√°kladƒõ pracovn√≠ doby servisu "
            "a dostupnosti mechanik≈Ø.\n\n"
            "Term√≠ny jsou aktualizov√°ny p≈ôi ka≈æd√©m obnoven√≠ obrazovky."
        )

    def open_settings(self):
        dialog = BookingSettingsDialog(parent=self)
        if dialog.exec() == QDialog.DialogCode.Accepted:
            self.refresh()
